const keyboard = [
    {
        id : 0,
        keyRu : ['ё'],
        keyEn : ['`', '~'],
        code : 'Backquote',
        classButton : ['button']
    },
    {
        id : 1,
        keyRu : ['1', '!'],
        keyEn : ['1', '!'],
        code : 'Digit1',
        classButton : ['button']
    },
    {
        id : 2,
        keyRu : ['2', '"'],
        keyEn : ['2', '@'],
        code : 'Digit2',
        classButton : ['button']
    },
    {
        id : 3,
        keyRu : ['3', '№'],
        keyEn : ['3', '#'],
        code : 'Digit3',
        classButton : ['button']
    },
    {
        id : 4,
        keyRu : ['4', ';'],
        keyEn : ['4', '$'],
        code : 'Digit4',
        classButton : ['button']
    },
    {
        id : 5,
        keyRu : ['5', '%'],
        keyEn : ['5', '%'],
        code : 'Digit5',
        classButton : ['button']
    },
    {
        id : 6,
        keyRu : ['6', ':'],
        keyEn : ['6', '^'],
        code : 'Digit6',
        classButton : ['button']
    },
    {
        id : 7,
        keyRu : ['7', '?'],
        keyEn : ['7', '&'],
        code : 'Digit7',
        classButton : ['button']
    },
    {
        id : 8,
        keyRu : ['8', '*'],
        keyEn : ['8', '*'],
        code : 'Digit8',
        classButton : ['button']
    },
    {
        id : 9,
        keyRu : ['9', '('],
        keyEn : ['9', '('],
        code : 'Digit9',
        classButton : ['button']
    },
    {
        id : 10,
        keyRu : ['0', ')'],
        keyEn : ['0', ')'],
        code : 'Digit0',
        classButton : ['button']
    },
    {
        id : 11,
        keyRu : ['-', '_'],
        keyEn : ['-', '_'],
        code : 'Minus',
        classButton : ['button']
    },
    {
        id : 12,
        keyRu : ['=', '+'],
        keyEn : ['=', '+'],
        code : 'Equal',
        classButton : ['button']
    },
    {
        id : 13,
        keyRu : ['Backspace'],
        keyEn : ['Backspace'],
        code : 'Backspace',
        classButton : ['button', 'button_backspace']
    },
    {
        id : 14,
        keyRu : ['Tab'],
        keyEn : ['Tab'],
        code : 'Tab',
        classButton : ['button', 'button_tab']
    },
    {
        id : 15,
        keyRu : ['й'],
        keyEn : ['q'],
        code : 'KeyQ',
        classButton : ['button']
    },
    {
        id : 16,
        keyRu : ['ц'],
        keyEn : ['w'],
        code : 'KeyW',
        classButton : ['button']
    },
    {
        id : 17,
        keyRu : ['у'],
        keyEn : ['e'],
        code : 'KeyE',
        classButton : ['button']
    },
    {
        id : 18,
        keyRu : ['к'],
        keyEn : ['r'],
        code : 'KeyR',
        classButton : ['button']
    },
    {
        id : 19,
        keyRu : ['е'],
        keyEn : ['t'],
        code : 'KeyT',
        classButton : ['button']
    },
    {
        id : 20,
        keyRu : ['н'],
        keyEn : ['y'],
        code : 'KeyY',
        classButton : ['button']
    },
    {
        id : 21,
        keyRu : ['г'],
        keyEn : ['u'],
        code : 'KeyU',
        classButton : ['button']
    },
    {
        id : 22,
        keyRu : ['ш'],
        keyEn : ['i'],
        code : 'KeyI',
        classButton :['button']
    },
    {
        id : 23,
        keyRu : ['щ'],
        keyEn : ['o'],
        code : 'KeyO',
        classButton : ['button']
    },
    {
        id : 24,
        keyRu : ['з'],
        keyEn : ['p'],
        code : 'KeyP',
        classButton : ['button']
    },
    {
        id : 25,
        keyRu : ['х'],
        keyEn : ['[', '{'],
        code : 'BracketLeft',
        classButton : ['button']
    },
    {
        id : 26,
        keyRu : ['ъ'],
        keyEn : [']', '}'],
        code : 'BracketRight',
        classButton : ['button']
    },
    {
        id : 27,
        keyRu : ['\\', '/'],
        keyEn : ['\\', '|'],
        code : 'Backslash',
        classButton : ['button']
    },
    {
        id : 43,
        keyRu : ['Del'],
        keyEn : ['Del'],
        code : 'Delete',
        classButton : ['button', 'button_delete']
    },
    {
        id : 28,
        keyRu : ['CapsLock'],
        keyEn : ['CapsLock'],
        code : 'CapsLock',
        classButton : ['button', 'button_caps_lock']
    },
    {
        id : 29,
        keyRu : ['ф'],
        keyEn : ['a'],
        code : 'KeyA',
        classButton : ['button']
    },
    {
        id : 31,
        keyRu : ['ы'],
        keyEn : ['s'],
        code : 'KeyS',
        classButton : ['button']
    },
    {
        id : 32,
        keyRu : ['в'],
        keyEn : ['d'],
        code : 'KeyD',
        classButton : ['button']
    },
    {
        id : 33,
        keyRu : ['а'],
        keyEn : ['f'],
        code : 'KeyF',
        classButton : ['button']
    },
    {
        id : 34,
        keyRu : ['п'],
        keyEn : ['g'],
        code : 'KeyG',
        classButton : ['button']
    },
    {
        id : 35,
        keyRu : ['р'],
        keyEn : ['h'],
        code : 'KeyH',
        classButton : ['button']
    },
    {
        id : 36,
        keyRu : ['о'],
        keyEn : ['j'],
        code : 'KeyJ',
        classButton : ['button']
    },
    {
        id : 37,
        keyRu : ['л'],
        keyEn : ['k'],
        code : 'KeyK',
        classButton : ['button']
    },
    {
        id : 38,
        keyRu : ['д'],
        keyEn : ['l'],
        code : 'KeyL',
        classButton : ['button']
    },
    {
        id : 39,
        keyRu : ['ж'],
        keyEn : [';', ':'],
        code : 'Semicolon',
        classButton : ['button']
    },
    {
        id : 40,
        keyRu : ['э'],
        keyEn : ['\'', '"'],
        code : 'Quote',
        classButton : ['button']
    },
    {
        id : 41,
        keyRu : ['Enter'],
        keyEn : ['Enter'],
        code : 'Enter',
        classButton : ['button', 'button_enter']
    },
    {
        id : 42,
        keyRu : ['Shift'],
        keyEn : ['Shift'],
        code : 'ShiftLeft',
        classButton : ['button', 'button_shift']
    },
    {
        id : 44,
        keyRu : ['я'],
        keyEn : ['z'],
        code : 'KeyZ',
        classButton : ['button']
    },
    {
        id : 45,
        keyRu : ['ч'],
        keyEn : ['x'],
        code : 'KeyX',
        classButton : ['button']
    },
    {
        id : 46,
        keyRu : ['с'],
        keyEn : ['c'],
        code : 'KeyC',
        classButton : ['button']
    },
    {
        id : 47,
        keyRu : ['м'],
        keyEn : ['v'],
        code : 'KeyV',
        classButton : ['button']
    },
    {
        id : 48,
        keyRu : ['и'],
        keyEn : ['b'],
        code : 'KeyB',
        classButton : ['button']
    },
    {
        id : 49,
        keyRu : ['т'],
        keyEn : ['n'],
        code : 'KeyN',
        classButton : ['button']
    },
    {
        id : 50,
        keyRu : ['ь'],
        keyEn : ['m'],
        code : 'KeyM',
        classButton : ['button']
    },
    {
        id : 51,
        keyRu : ['б'],
        keyEn : [',', '<'],
        code : 'Comma',
        classButton : ['button']
    },
    {
        id : 52,
        keyRu : ['ю'],
        keyEn : ['.', '>'],
        code : 'Period',
        classButton : ['button']
    },
    {
        id : 53,
        keyRu : ['.', ','],
        keyEn : ['/', '?'],
        code : 'Slash',
        classButton : ['button']
    },
    {
        id : 54,
        keyRu : ['↑'],
        keyEn : ['↑'],
        code : 'ArrowUp',
        classButton : ['button']
    },
    {
        id : 55,
        keyRu : ['Shift'],
        keyEn : ['Shift'],
        code : 'ShiftRight',
        classButton : ['button', 'button_shift']
    },
    {
        id : 56,
        keyRu : ['Ctrl'],
        keyEn : ['Ctrl'],
        code : 'ControlLeft',
        classButton : ['button', 'button_ctrl']
    },
    {
        id : 57,
        keyRu : ['Win'],
        keyEn : ['Win'],
        code : 'Meta',
        classButton : ['button']
    },
    {
        id : 58,
        keyRu : ['Alt'],
        keyEn : ['Alt'],
        code : 'AltLeft',
        classButton : ['button', 'button_alt']
    },
    {
        id : 59,
        keyRu : [' '],
        keyEn : [' '],
        code : 'Space',
        classButton : ['button', 'button_space']
    },
    {
        id : 60,
        keyRu : ['Alt'],
        keyEn : ['Alt'],
        code : 'AltRight',
        classButton : ['button', 'button_alt']
    },
    {
        id : 61,
        keyRu : ['←'],
        keyEn : ['←'],
        code : 'ArrowLeft',
        classButton : ['button']
    },
    {
        id : 62,
        keyRu : ['↓'],
        keyEn : ['↓'],
        code : 'ArrowDown',
        classButton : ['button']
    },
    {
        id : 63,
        keyRu : ['→'],
        keyEn : ['→'],
        code : 'ArrowRight',
        classButton : ['button']
    },
    {
        id : 64,
        keyRu : ['Ctrl'],
        keyEn : ['Ctrl'],
        code : 'ControlRight',
        classButton : ['button', 'button_ctrl']
    }
];

let CL = false;
let SH = false;
let AL = false;
let position;
let positionEnd;
let pressed = new Set();
let language = localStorage.getItem('lang');

function loadBody() {
    document.body.innerHTML = '<section class="overlay"></section>';
    document.querySelector('.overlay').innerHTML = `<h1>Virtual Keyboard</h1><textarea name="" class="input" cols="30" rows="10"></textarea>
    <div class="keyboard"></div><p>Клавиатура создана в операционной системе Windows.<br>Для переключения языка: Alt + Shift.</p>`;
}
function loadBodyRu() {
    document.querySelector('.keyboard').innerHTML = '';
    keyboard.forEach(el => {
        let classButton = '';
        el.classButton.forEach(elem => {
            classButton += ` ${elem}`;
        });
        let letter = '';
        if (el.keyRu.length > 1){
            letter += `${el.keyRu[0]}`;
            letter += ` <span class = 'second'>${el.keyRu[1]}</span>`;
        } else {
            letter += `${el.keyRu[0]}`;
        }
        if (el.code === 'CapsLock'){
            if (!CL){
                document.querySelector('.keyboard').innerHTML += `<div class='${classButton}' data-code=${el.code} >${letter}</div>`;
            } else {
                document.querySelector('.keyboard').innerHTML += `<div id='button_active' class='${classButton}' data-code=${el.code} >${letter}</div>`;
            }
        } else {
            document.querySelector('.keyboard').innerHTML += `<div class='${classButton}' data-code=${el.code} >${letter}</div>`;
        }
    });
}

const loadBodyEn = () =>{
    document.querySelector('.keyboard').innerHTML = '';
    keyboard.forEach(el => {
        let classButton = '';
        el.classButton.forEach(elem => {
            classButton += ` ${elem}`;
        });
        let letter = '';
        if (el.keyEn.length > 1){
            letter += `${el.keyEn[0]}`;
            letter += ` <span class = 'second'>${el.keyEn[1]}</span>`;
        } else {
            letter += `${el.keyEn[0]}`;
        }
        if (el.code === 'CapsLock'){
            if (!CL){
                document.querySelector('.keyboard').innerHTML += `<div class='${classButton}'  data-code=${el.code} >${letter}</div>`;
            } else {
                document.querySelector('.keyboard').innerHTML += `<div id='button_active' class='${classButton}' data-code=${el.code} >${letter}</div>`;
            }
        } else {
            document.querySelector('.keyboard').innerHTML += `<div class='${classButton}' data-code=${el.code} >${letter}</div>`;
        }
    });
};
const pos = () =>{
    document.querySelector('.input').addEventListener('click', ()=>{
        position = document.querySelector('.input').selectionStart;
        positionEnd = document.querySelector('.input').selectionEnd;
    });
};
const buttonAnimation = (pres) => {
    pres.forEach(code => {
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code === code){
                el.id = 'button_active';
            }
        });
    });
};

const letterLower = () => {
   if (language === 'En'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Key'){
                let i = el.innerHTML.toLocaleLowerCase();
                el.innerHTML = i;
            }
        });
    } else if (language === 'Ru'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Key' || el.dataset.code === 'Period' || el.dataset.code === 'Backquote' || el.dataset.code === 'BracketLeft' || el.dataset.code === 'BracketRight' || el.dataset.code === 'Semicolon' || el.dataset.code === 'Quote' || el.dataset.code === 'Comma'){
                let i = el.innerHTML.toLocaleLowerCase();
                el.innerHTML = i;
            }
        });
    }
};

const letterUpper = () => {
    if (language === 'En'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Key'){
                let i = el.innerHTML.toLocaleUpperCase();
                el.innerHTML = i;
            }
        });
    } else if (language === 'Ru'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Key' || el.dataset.code === 'Period' || el.dataset.code === 'Backquote' || el.dataset.code === 'BracketLeft' || el.dataset.code === 'BracketRight' || el.dataset.code === 'Semicolon' || el.dataset.code === 'Quote' || el.dataset.code === 'Comma'){
                let i = el.innerHTML.toLocaleUpperCase();
                el.innerHTML = i;
            }
        });
    }
};

const letterShift = () =>{
    if (language === 'En'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Digit' || el.dataset.code === 'Minus' || el.dataset.code === 'Equal' || el.dataset.code === 'Slash' || el.dataset.code === 'Period' || el.dataset.code === 'Backquote' || el.dataset.code === 'BracketLeft' || el.dataset.code === 'BracketRight' || el.dataset.code === 'Semicolon' || el.dataset.code === 'Quote' || el.dataset.code === 'Comma' || el.dataset.code === 'Backslash'){
                    let i = el.innerHTML.substring(0, el.innerHTML.search(' '));
                    let j = el.querySelector('.second').innerHTML;
                    el.innerHTML = j + el.innerHTML.substring(el.innerHTML.search(' '));
                    el.querySelector('.second').innerHTML = i;
            }
        });
    } else if (language === 'Ru'){
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code.slice(0, -1) === 'Digit' || el.dataset.code === 'Minus' || el.dataset.code === 'Equal' || el.dataset.code === 'Slash' || el.dataset.code === 'Backslash'){
                    let i = el.innerHTML.substring(0, el.innerHTML.search(' '));
                    let j = el.querySelector('.second').innerHTML;
                    el.innerHTML = j + el.innerHTML.substring(el.innerHTML.search(' '));
                    el.querySelector('.second').innerHTML = i;
            }
        });
    }
};
const switchDown = (event) => {
    let lengthInput = document.querySelector('.input').value.length;
    let start = document.querySelector('.input').value.substring(0, position);
    let end = document.querySelector('.input').value.substring(position);
    switch (event.code) {
        case 'CapsLock':
            if (CL){
                CL = false;
                letterLower();
            } else {
                CL = true;
                letterUpper();
            }
            break;
        case 'ShiftLeft':
            if (CL){
                SH = true;
                letterShift();
                letterLower();
            } else {
                SH = true;
                letterShift();
                letterUpper();
            }
            break;
        case 'ShiftRight':
            if (CL){
                SH = true;
                letterShift();
                letterLower();
            } else {
                SH = true;
                letterShift();
                letterUpper();
            }
            break;
        case 'AltRight':
            AL = true;
            break;
        case 'AltLeft':
            AL = true;
            break;
        case 'ControlRight':
            break;
        case 'Enter':
            document.querySelector('.input').value += '\r';
            position = `${start} `.length;
            positionEnd = position;
            break;
        case 'ControlLeft':
            break;
        case 'Meta':
            break;
        case 'Space':
            if (position === lengthInput){
                document.querySelector('.input').value += ' ';
                position = `${start} `.length;
                positionEnd = position;
            } else {
                document.querySelector('.input').value = `${start} ${end}`;
                position = `${start} `.length;
                positionEnd = position;
                document.querySelector('.input').setSelectionRange(position, position);
            }
            break;
        case 'Backspace':
            if (position > 0){
                if (position === lengthInput){
                    document.querySelector('.input').value = document.querySelector('.input').value.substring(0, lengthInput - 1);
                    position --;
                } else {
                    start = document.querySelector('.input').value.substring(0, position);
                    end = document.querySelector('.input').value.substring(positionEnd);
                    if (position === positionEnd) {
                        position --;
                        start = document.querySelector('.input').value.substring(0, position);
                        document.querySelector('.input').value = `${start + end}`;
                        positionEnd = position;
                        document.querySelector('.input').setSelectionRange(position, position);
                    } else {
                        document.querySelector('.input').value = `${start + end}`;
                        document.querySelector('.input').setSelectionRange(position, position);
                        positionEnd = position;
                    }
                }
            } else if (position !== positionEnd){
                    start = document.querySelector('.input').value.substring(0, position);
                    end = document.querySelector('.input').value.substring(positionEnd);
                    document.querySelector('.input').value = `${start + end}`;
                    document.querySelector('.input').setSelectionRange(position, position);
                    positionEnd = position;
            }
            break;
        case 'Delete':
            if (position < lengthInput){
                    start = document.querySelector('.input').value.substring(0, position);
                    end = document.querySelector('.input').value.substring(positionEnd + 1);
                    if (position === positionEnd) {
                        document.querySelector('.input').value = `${start + end}`;
                        document.querySelector('.input').setSelectionRange(position, position);
                    } else {
                        end = document.querySelector('.input').value.substring(positionEnd);
                        document.querySelector('.input').value = `${start + end}`;
                        document.querySelector('.input').setSelectionRange(position, position);
                    }
            }
            break;
        case 'Tab':
          if (position === lengthInput){
            document.querySelector('.input').value += '    ';
            position = `${start}    `.length;
            positionEnd = position;
           } else {
            document.querySelector('.input').value = `${start}    ${end}`;
            position = `${start}    `.length;
            positionEnd = position;
            document.querySelector('.input').setSelectionRange(position, position);
           }
           break;
        case 'ArrowLeft':
            if (position >= 1){
                position--;
                positionEnd = position;
            }
            document.querySelector('.input').setSelectionRange(position, position);
            break;
        case 'ArrowRight':
            if (position < lengthInput){
                position++;
                positionEnd = position;
            }
            document.querySelector('.input').setSelectionRange(position, position);
            break;
        default:
            document.querySelectorAll('.button').forEach(el => {
                if (el.dataset.code === event.code){
                    if (CL && SH){
                        letterLower();
                    }
                    if (position === lengthInput){
                        document.querySelector('.input').value += el.innerText.charAt(0);
                        position = `${start + el.innerText.charAt(0)}`.length;
                        positionEnd = position;
                        document.querySelector('.input').setSelectionRange(position, position);
                    } else {
                        document.querySelector('.input').value = `${start}${el.innerText.charAt(0)}${end}`;
                        position = `${start + el.innerText.charAt(0)}`.length;
                        positionEnd = position;
                        document.querySelector('.input').setSelectionRange(position, position);
                    }
                }
            });
    }
    if (AL && SH){
        if (language === 'En'){
            language = 'Ru';
            loadBodyRu();
            letterShift();
            localStorage.setItem('lang', language);
        } else if (language === 'Ru') {
            language = 'En';
            loadBodyEn();
            letterShift();
            localStorage.setItem('lang', language);
        }
    }
    pressed.add(event.code);
    buttonAnimation(pressed);
};

const click = () => {
    document.querySelector('.keyboard').addEventListener('mousedown', (event) =>{
        if (event.target.classList.contains('button')) {
            switchDown(event.target.dataset);
        }
    });
    document.querySelector('.keyboard').addEventListener('mouseup', (event) => {
        if (event.target.classList.contains('button')) {
            if (event.target.dataset.code === 'ShiftLeft' || event.target.dataset.code === 'ShiftRight'){
                if (CL){
                    SH = false;
                    letterShift();
                    letterUpper();
                } else {
                    SH = false;
                   letterShift();
                    letterLower();
                }
            }
            if (event.target.dataset.code === 'AltLeft' || event.target.dataset.code === 'AltRight'){
                AL = false;
            }
            document.querySelectorAll('.button').forEach(el => {
                if (el.dataset.code === event.target.dataset.code){
                    if (event.target.dataset.code === 'CapsLock'){
                        if (!CL){
                            setTimeout(() => {
                                el.id = '';
                            }, 300);
                        }
                    } else {
                        setTimeout(() => {
                            el.id = '';
                        }, 300);
                    }
                }
            });
            pressed.delete(event.target.dataset.code);
        }
    });
};

const keyBoard = () => {
    document.addEventListener('keydown', (event) =>{
        if (!event.repeat){
            switchDown(event);
        }
        event.preventDefault();
    });

    document.addEventListener('keyup', (event) => {

        if (event.code === 'ShiftLeft' || event.code === 'ShiftRight'){
            if (CL){
                SH = false;
               letterShift();
                letterUpper();
            } else {
                SH = false;
               letterShift();
                letterLower();
            }
        }
        if (event.code === 'AltLeft' || event.code === 'AltRight'){
            AL = false;
        }
        document.querySelectorAll('.button').forEach(el => {
            if (el.dataset.code === event.code){
                    if (event.code === 'CapsLock'){
                        if (!CL){
                            setTimeout(() => {
                                el.id = '';
                            }, 300);
                        }
                    } else {
                        setTimeout(() => {
                            el.id = '';
                        }, 300);
                    }
            }
        });
        pressed.delete(event.code);
    });
};


window.onload = () => {
    if (language){
        if (language === 'En'){
            loadBody();
            loadBodyEn();
        } else if (language === 'Ru') {
            loadBody();
            loadBodyRu();
        }
    } else {
        loadBody();
        loadBodyEn();
        language = 'En';
    }
    click();
    keyBoard();
    pos();
};
